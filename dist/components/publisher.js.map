{"version":3,"sources":["../../src/components/publisher.js"],"names":["Configurable","require","Component","axon","portfinder","module","exports","advertisement","discoveryOptions","sock","types","type","on","startDiscovery","onPort","err","port","bind","server","code","getPort","host","address","topic","data","indexOf","parts","split","room","namespace","wrapper","wrap","emit"],"mappings":";;;;;;;;;;AAAA,IAAMA,eAAeC,QAAQ,gBAAR,CAArB;AACA,IAAMC,YAAYD,QAAQ,aAAR,CAAlB;AACA,IAAME,OAAOF,QAAQ,gBAAR,CAAb;AACA,IAAMG,aAAaH,QAAQ,YAAR,CAAnB;;AAEAI,OAAOC,OAAP;AAAA;;AACI,uBAAYC,aAAZ,EAA2BC,gBAA3B,EAA6C;AAAA;;AAAA,0HACnCD,aADmC,EACpBC,gBADoB;;AAGzC,cAAKC,IAAL,GAAY,IAAIN,KAAKO,KAAL,CAAW,MAAKC,IAAhB,CAAJ,EAAZ;AACA,cAAKF,IAAL,CAAUA,IAAV,CAAeG,EAAf,CAAkB,MAAlB,EAA0B;AAAA,mBAAM,MAAKC,cAAL,EAAN;AAAA,SAA1B;;AAEA,YAAMC,SAAS,SAATA,MAAS,CAACC,GAAD,EAAMC,IAAN,EAAe;AAC1B,kBAAKT,aAAL,CAAmBS,IAAnB,GAA0B,CAACA,IAA3B;;AAEA,kBAAKP,IAAL,CAAUQ,IAAV,CAAeD,IAAf;AACA,kBAAKP,IAAL,CAAUA,IAAV,CAAeS,MAAf,CAAsBN,EAAtB,CAAyB,OAAzB,EAAkC,UAACG,GAAD,EAAS;AACvC,oBAAIA,IAAII,IAAJ,IAAY,YAAhB,EAA8B,MAAMJ,GAAN;;AAE9BX,2BAAWgB,OAAX,CAAmB;AACfC,0BAAM,MAAKb,gBAAL,CAAsBc,OADb;AAEfN,0BAAM,MAAKT,aAAL,CAAmBS;AAFV,iBAAnB,EAGGF,MAHH;AAIH,aAPD;AAQH,SAZD;;AAcAV,mBAAWgB,OAAX,CAAmB;AACfC,kBAAM,MAAKb,gBAAL,CAAsBc,OADb;AAEfN,kBAAMT,cAAcS;AAFL,SAAnB,EAGGF,MAHH;AApByC;AAwB5C;;AAzBL;AAAA;AAAA,6BA2BSS,KA3BT,EA2BgBC,IA3BhB,EA2BsB;AACd,gBAAID,MAAME,OAAN,CAAc,GAAd,IAAqB,CAAzB,EAA4B;AACxB,oBAAMC,QAAQH,MAAMI,KAAN,CAAY,GAAZ,CAAd;AACA,uBAAO;AACHJ,2BAAOG,MAAM,CAAN,CADJ;AAEHE,0BAAMF,MAAM,CAAN,CAFH;AAGHF,0BAAMA;AAHH,iBAAP;AAKH;AACD,mBAAO,EAAED,OAAOA,KAAT,EAAgBC,MAAMA,IAAtB,EAAP;AACH;AArCL;AAAA;AAAA,gCAuCYD,KAvCZ,EAuCmBC,IAvCnB,EAuCyB;AACjB,gBAAIK,YAAY,EAAhB;;AAEA,gBAAI,KAAKtB,aAAL,CAAmBsB,SAAvB,EAAkC;AAC9BA,4BAAY,KAAKtB,aAAL,CAAmBsB,SAAnB,GAA+B,IAA3C;AACH;;AAEDN,oBAAQ,cAAcM,SAAd,GAA0BN,KAAlC;AACA,gBAAMO,UAAU,KAAKC,IAAL,CAAUR,KAAV,EAAiBC,IAAjB,CAAhB;AACAD,oBAAQO,QAAQP,KAAhB;AACA,mBAAOO,QAAQP,KAAf;AACA,iBAAKd,IAAL,CAAUuB,IAAV,CAAeT,KAAf,EAAsBO,OAAtB;AACH;AAnDL;AAAA;AAAA,4BAqDe;AACP,mBAAO,aAAP;AACH;AAvDL;AAAA;AAAA,4BAyDe;AACP,mBAAO,aAAP;AACH;AA3DL;;AAAA;AAAA,EAAyC9B,aAAaE,SAAb,CAAzC","file":"publisher.js","sourcesContent":["const Configurable = require('./configurable');\nconst Component = require('./component');\nconst axon = require('@dashersw/axon');\nconst portfinder = require('portfinder');\n\nmodule.exports = class Publisher extends Configurable(Component) {\n    constructor(advertisement, discoveryOptions) {\n        super(advertisement, discoveryOptions);\n\n        this.sock = new axon.types[this.type]();\n        this.sock.sock.on('bind', () => this.startDiscovery());\n\n        const onPort = (err, port) => {\n            this.advertisement.port = +port;\n\n            this.sock.bind(port);\n            this.sock.sock.server.on('error', (err) => {\n                if (err.code != 'EADDRINUSE') throw err;\n\n                portfinder.getPort({\n                    host: this.discoveryOptions.address,\n                    port: this.advertisement.port,\n                }, onPort);\n            });\n        };\n\n        portfinder.getPort({\n            host: this.discoveryOptions.address,\n            port: advertisement.port,\n        }, onPort);\n    }\n\n    wrap(topic, data) {\n        if (topic.indexOf('@') > 0) {\n            const parts = topic.split('@');\n            return {\n                topic: parts[0],\n                room: parts[1],\n                data: data,\n            };\n        }\n        return { topic: topic, data: data };\n    }\n\n    publish(topic, data) {\n        let namespace = '';\n\n        if (this.advertisement.namespace) {\n            namespace = this.advertisement.namespace + '::';\n        }\n\n        topic = 'message::' + namespace + topic;\n        const wrapper = this.wrap(topic, data);\n        topic = wrapper.topic;\n        delete wrapper.topic;\n        this.sock.emit(topic, wrapper);\n    };\n\n    get type() {\n        return 'pub-emitter';\n    }\n\n    get oppo() {\n        return 'sub-emitter';\n    }\n};\n"]}