{"version":3,"sources":["../../src/components/subscriber.js"],"names":["Configurable","require","Monitorable","Component","axon","module","exports","advertisement","discoveryOptions","startDiscovery","sock","types","type","set","subscribesTo","self","forEach","topic","namespace","on","args","length","unshift","substr","isSockend","strip","emit","data","obj","address","constructor","useHostNames","hostName","alreadyConnected","socks","some","s","_host","remoteAddress","remotePort","port","connect","listener","formatTypeWithNamespace"],"mappings":"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","file":"subscriber.js","sourcesContent":["const Configurable = require('./configurable');\nconst Monitorable = require('./monitorable');\nconst Component = require('./component');\nconst axon = require('@dashersw/axon');\n\nmodule.exports = class Subscriber extends Monitorable(Configurable(Component)) {\n    constructor(advertisement, discoveryOptions) {\n        super(advertisement, discoveryOptions);\n\n        this.startDiscovery();\n\n        this.sock = new axon.types[this.type]();\n        this.sock.sock.set('retry timeout', 0);\n\n        this.advertisement.subscribesTo = this.advertisement.subscribesTo || ['*'];\n\n        const self=this;\n        this.advertisement.subscribesTo.forEach((topic) => {\n            let namespace = '';\n            if (this.advertisement.namespace) {\n                namespace = this.advertisement.namespace + '::';\n            }\n\n            topic = 'message::' + namespace + topic;\n\n            ((topic) => {\n                this.sock.on(topic, (...args) => {\n                    if (args.length == 1) {\n                        args.unshift(topic.substr(9));\n                    } else {\n                        args[0] = namespace + args[0];\n                    }\n                    if (!self.advertisement.isSockend) {\n                        self.strip(args);\n                    }\n                    this.emit(...args);\n                });\n            })(topic);\n        });\n    }\n\n    strip(args) {\n        args[1] = args[1].data;\n    }\n\n    onAdded(obj) {\n        super.onAdded(obj);\n\n        const address = this.constructor.useHostNames ? obj.hostName : obj.address;\n\n        const alreadyConnected = this.sock.sock.socks.some((s) =>\n            (this.constructor.useHostNames ? s._host == obj.hostName : s.remoteAddress == address) &&\n            s.remotePort == obj.advertisement.port);\n\n        if (alreadyConnected) return;\n\n        this.sock.connect(obj.advertisement.port, address);\n    }\n\n    on(type, listener) {\n        return super.on(this.formatTypeWithNamespace(type), listener);\n    }\n\n    formatTypeWithNamespace(type) {\n        let namespace = '';\n        if (this.advertisement.namespace) {\n            namespace = this.advertisement.namespace + '::';\n        }\n\n        return namespace + type;\n    }\n\n    get type() {\n        return 'sub-emitter';\n    }\n\n    get oppo() {\n        return 'pub-emitter';\n    }\n};\n"]}